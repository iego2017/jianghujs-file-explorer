<template id="file-detail">
  <!-- 文件详情 >>>>>>>>>>>>> --> 
  <v-card style="width: 100%">
    <v-card-text>
      <!--✅路径-->
      <div class="text-center mb-4">{{ `${host}/<$ ctx.app.config.appId $>/upload/cloudDrive${currentPath}` }}</div>
      <!--✅markdown-->
      <div v-if="fileType === 'markdown'" style="height: calc(100vh - 255px); overflow: auto;">
        <!--✅内容-->
        <md2html v-if="markdownContent" :article-content="markdownContent"></md2html>
        <!--✅加载状态-->
        <div v-else class="text-center pa-10">
          <v-progress-circular indeterminate :size="30" color="primary"></v-progress-circular>
          <span>加载中</span>
        </div>
      </div>
      <!--✅文件-->
      <template v-else>
        <!--✅图片-->
        <v-img v-if="fileType === 'image'" min-width="30" max-width="500" min-height="30" max-height="500"
          :src="`/<$ ctx.app.config.appId $>/upload/cloudDrive${currentPath}?v=${new Date().getTime()}`" :key="currentPath"
          lazy-src=""
          class="grey lighten-2 mb-5" style="margin: auto; cursor: pointer;"
          @click="doUiAction('openFile', `/<$ ctx.app.config.appId $>/upload/cloudDrive${currentPath}?v=${new Date().getTime()}`)">
        </v-img>
        <!--✅视频-->
        <video v-if="fileType === 'video'" width="80%" min-width="30" max-width="500" min-height="30" max-height="500"
          style="height: 70vh"
          :src="`/<$ ctx.app.config.appId $>/upload/cloudDrive${currentPath}?v=${new Date().getTime()}`" :key="currentPath"
          lazy-src=""
          class="grey lighten-2 mb-5" style="display: block; margin: auto;" controls>
          <source :src="`/<$ ctx.app.config.appId $>/upload/cloudDrive${currentPath}?v=${new Date().getTime()}`" type="video/mp4">
        </video>
        <!--✅音频-->
        <audio v-if="fileType === 'audio'" min-width="30" max-width="500" min-height="30" max-height="500"
          :src="`/<$ ctx.app.config.appId $>/upload/cloudDrive${currentPath}?v=${new Date().getTime()}`" :key="currentPath"
          lazy-src=""
          class="my-10" style="display: block; margin: auto;" controls>
          <source :src="`/<$ ctx.app.config.appId $>/upload/cloudDrive${currentPath}?v=${new Date().getTime()}`"
            type="audio/mpeg">
        </audio>
      </template>
    </v-card-text>
  </v-card>
  <!-- <<<<<<<<<<<<< 文件详情 -->
</template>

<script>
  Vue.component("file-detail", {
    vuetify: new Vuetify(),
    name: 'file-detail',
    template: '#file-detail',
    props: {
      currentPath: String,
    },
    data: () => ({
      host: window.location.host,
      markdownContent: null
    }),
    created() {
      if (this.fileType === 'markdown') {
        this.doUiAction('getMarkdownContent')
      }
    },
    computed: {
      fileType() {
        const ext = this.currentPath.substring(this.currentPath.lastIndexOf('.') + 1);
        if (ext) {
          if (['jpg', 'jpeg', 'png', 'gif', 'ico', 'svg'].includes(ext.toLowerCase())) {
            return 'image';
          }
          if (['mp4'].includes(ext.toLowerCase())) {
            return 'video';
          }
          if (['mp3'].includes(ext.toLowerCase())) {
            return 'audio';
          }
          if (['md'].includes(ext.toLowerCase())) {
            return 'markdown';
          }
        }
        return '';
      }
    },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'getMarkdownContent':
            await this.getMarkdownContent();
            break;
          case 'openFile':
            await this.openFile(uiActionData);
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      
      // ---------- 获取markdown文件的内容 uiAction >>>>>>>>>> --------
      async getMarkdownContent() {
        this.markdownContent = (await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'cloud_drive',
              actionId: 'getMarkdownContent',
              actionData: {
                path: this.currentPath
              },
            }
          }
        })).data.appData.resultData.mdContent;
      },
      // ---------- <<<<<<<<<<< 获取markdown文件的内容 uiAction  --------

      // ---------- 打开文件 uiAction >>>>>>>>>> --------
      openFile(path) {
        window.open(path)
      },
      // ---------- <<<<<<<<<<< 打开文件 uiAction  --------
    }
  });
</script>
