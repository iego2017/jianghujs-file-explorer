<template id="mdDialog">
  <div>
    <!--✅文档编辑器弹窗-->
    <v-dialog v-model="shown" persistent>
      <v-card flat style="height: 70vh" class="d-flex flex-column">
        <div style="height: 48px">
          <!--✅弹窗标题栏-->
          <v-app-bar color="primary" dense dark class="pl-4">
            <v-icon>mdi-note-edit</v-icon>
            <v-toolbar-title class="ml-3">{{ mdName || "新建文档" }}</v-toolbar-title>
            <v-spacer></v-spacer>
            <v-btn class="mx-0 elevation-0" color="success" fab dark small @click="checkEditStatusAndClose">
              <v-icon color="white" size="30">
                mdi-close
              </v-icon>
            </v-btn>
          </v-app-bar>
        </div>
        <!--✅文档容器>>>>>>>>>>>>>-->
        <div id="editorMdContainer" v-if="shown" style="flex: 1">
          <textarea style="display:none;">{{mdContent}}</textarea>
        </div>
        <!--✅<<<<<<<<<<<< 文档容器-->
        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn color="success darken-1" text @click="checkEditStatusAndClose">
            取消
          </v-btn>
          <v-btn color="success" @click="saveMarkdownContent">
            保存
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
    <!--✅文档命名弹窗-->
    <v-dialog v-model="nameDialogShow"
              persistent
              hide-overlay
              :max-width="saveIng ? '100px' : '600px'">
      <!--✅文档保存中-->
      <div v-if="saveIng" style="height: 100px; width: 100px; text-align: center; padding: 20px; background-color: #ffffff">
        <v-progress-circular indeterminate :size="40" color="primary"></v-progress-circular>
        <div style="text-align: center">保存中</div>
      </div>
      <!--✅输入文档名输入框-->
      <v-card v-else>
        <v-form>
          <v-card-title class="px-8">
            <span class="text-h5">请输入保存文档名</span>
          </v-card-title>
          <v-card-text>
            <v-container>
              <v-text-field
                  label="请输入保存文档名"
                  v-model="mdName"
                  :rules="requireRules"
                  required
              ></v-text-field>
            </v-container>
          </v-card-text>
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="" text @click="cancelMdEdit">
              取消
            </v-btn>
            <v-btn color="success" text @click="saveMarkdownContent">
              保存
            </v-btn>
          </v-card-actions>
        </v-form>
      </v-card>
    </v-dialog>
  </div>
</template>
<link rel="stylesheet" href="/<$ ctx.app.config.appId $>/public/plugin/editor.md/css/editormd.min.css"/>
<script src="/<$ ctx.app.config.appId $>/public/lib/jquery/jquery.min.js"></script>
<script src="/<$ ctx.app.config.appId $>/public/plugin/editor.md/editormd.js"></script>

<script>
Vue.component("md-dialog", {
  vuetify: new Vuetify(),
  name: 'md-dialog',
  template: '#mdDialog',
  model: {
    prop: "shown",
    event: "close",
  },
  props: {
    shown: {
      type: Boolean,
      default: false,
    },
    defaultMd: {
      type: Object,
      default: null,
    },
  },
  data: () => ({
    requireRules: [v => !!v || '请输入文件名'],
    upload: window.appInfo.upload,
    editor: null,
    mdChanged: false,
    mdContent: null,
    mdSeo: null,
    mdName: null,
    nameDialogShow: false,
    saveIng: false
  }),
  computed: {},
  watch: {
    defaultMd: {
      deep: true,
      immediate: true,
      async handler(value) {
        // 文档编辑模式：文档名
        if (value && value.name) {
          this.mdName = value.name.substring(0, value.name.lastIndexOf('.'));
          this.$forceUpdate();
        }
        // 文档编辑模式：内容
        if (value && value.content) {
          this.mdContent = value.content;
        }
      }
    },
    shown(value) {
      if (!value) {
        // 关闭文档编辑器，清理数据
        this.$emit('close');
        this.nameDialogShow = false;
        this.saveIng = false;
        this.mdName = null;
        this.mdContent = null;
      } else {
        // 打开编辑器弹窗，重新初始化文档编辑器
        this.initEditorMd();
      }
    }
  },
  async mounted() {
  },
  methods: {
    /**
     * 检查文档内容是否修改，并提示是否保存
     * @returns {Promise<void>}
     */
    async checkEditStatusAndClose() {
      // 文档内容变动，提示是否要保存
      if (!_.isEmpty(this.mdContent) && (!this.defaultMd || (this.defaultMd && this.mdContent !== this.defaultMd.content))) {
        if (await window.confirmDialog({title: "有内容尚未保存是否保存"})) {
          // 确认保存，打开输入名称弹窗
          this.nameDialogShow = true;
          return;
        }
      }
      this.$emit('close');
    },
    /**
     * 取消文档编辑
     */
    cancelMdEdit() {
      this.$emit('close');
    },
    /**
     * 保存文档
     */
    saveMarkdownContent() {
      if (!_.isEmpty(this.mdName)) {
        this.nameDialogShow = true;
        this.saveIng = true;
        this.$emit("save-content", {content: this.mdContent, mdName: this.mdName});
      } else {
        this.nameDialogShow = true;
      }
    },
    /**
     * 初始化编辑器
     */
    initEditorMd() {
      const that = this;
      this.$nextTick(() => {
        if (document.getElementById('editorMdContainer')) {
          console.log("that.mdContent", that.mdContent)
          document.getElementById('editorMdContainer').innerHTML = `<textarea style=\"display:none;\">${that.mdContent || ""}</textarea>`;
          that.editor = editormd('editorMdContainer', {
            width: "100%",
            height: "100%",
            watch: false,
            saveHTMLToTextarea: true,    // 保存 HTML 到 Textarea
            htmlDecode: "style,script,iframe|on*",
            path: '/<$ ctx.app.config.appId $>/public/plugins/editor.md/lib/',
            toolbarIcons: Object.freeze([
              "undo", "redo", "|",
              "watch",
              "preview", "|",
              "h1", "h2", "h3", "h4", "h5", "bold", "del", "italic", "quote", "mark",
              "list-ul", "list-ol", "hr", "link", "|",
            ]),
            toolbarIconsClass: {
              audioUpload: 'fa-file-audio-o',
              videoUpload: 'fa-youtube-play',
              imageUpload: 'fa-image',
            },
            onchange: function () {
              that.mdChanged = true;
              that.mdContent = this.getMarkdown();
              that.mdSeo = this.getPreviewedHTML2();
            },
          });
        } else {
          requestAnimationFrame(() => {
            this.initEditorMd();
          })
        }
      })
    }
  }
})
</script>

<style scoped>
body {
  overflow: auto;
}

.v-card {
  height: unset;
}

:root {
  --border-color: #eff2f5;
}

.v-dialog--fullscreen .v-sheet {
  height: auto;
  position: relative;
  background: #fff;
  display: block;
}

.editormd, .CodeMirror-gutters, .editormd-toolbar, .editormd .CodeMirror, .editormd-menu > li.divider, .editormd-menu > li > a:hover, .editormd-menu > li > a.active {
  border-color: var(--border-color) !important;
}

.CodeMirror-gutter {
  background-color: #fff;
}

.CodeMirror-scroll {
  overflow-x: hidden !important;
}

.editormd-dialog-close {
  color: #3F4254 !important;
}

.editormd-preview-container ol.linenums li, .editormd-html-preview ol.linenums li {
  list-style-type: none;
}

.editormd-preview-container ol.linenums, .editormd-html-preview ol.linenums {
  color: #999;
  padding-left: 0;
}
</style>
