<template id="markdown-editor">
  <div>
    <!-- 新建文档按钮 >>>>>>>>>>>>> --> 
    <v-btn class="ml-2" small v-if="currentPath" depressed @click="openMarkdownEditDialog" title="Upload Files" :disabled="currentPath === '/'">
      <v-icon class="mr-1" small>mdi-text-box-plus</v-icon>
      新建文档
    </v-btn>
    <!-- <<<<<<<<<<<<< 新建文档按钮 -->

    <!-- 文档编辑器弹窗 >>>>>>>>>>>>> --> 
    <v-dialog v-model="isMarkdownEditDialogShow" persistent>
      <v-card flat style="height: 70vh" class="d-flex flex-column">
        <!--✅弹窗标题栏-->
        <div style="height: 48px">
          <v-app-bar color="primary" dense dark class="pl-4">
            <v-icon>mdi-note-edit</v-icon>
            <v-toolbar-title class="ml-3">
              {{ mdName || "新建文档" }}
              <v-progress-circular v-if="saveIng" indeterminate :size="20" color="white"></v-progress-circular>
            </v-toolbar-title>
            <v-spacer></v-spacer>
            <v-btn class="mx-0 elevation-0" color="success" fab dark small @click="checkEditStatusAndClose">
              <v-icon color="white" size="30">
                mdi-close
              </v-icon>
            </v-btn>
          </v-app-bar>
        </div>

        <!--✅文档容器-->
        <div id="editorMdContainer" v-if="isMarkdownEditDialogShow" style="flex: 1"></div>

        <!--✅操作按钮-->
        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn color="success darken-1" text @click="checkEditStatusAndClose">
            取消
          </v-btn>
          <v-btn color="success" @click="saveMarkdownContent">
            保存
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
    <!-- <<<<<<<<<<<<< 文档编辑器弹窗 -->

    <!-- 文档命名弹窗 >>>>>>>>>>>>> --> 
    <v-dialog v-model="isNameDialogShow"
              persistent
              hide-overlay
              :max-width="saveIng ? '100px' : '600px'">
      <!--✅文档保存中-->
      <div v-if="saveIng" style="height: 100px; width: 100px; text-align: center; padding: 20px; background-color: #ffffff">
        <v-progress-circular indeterminate :size="40" color="primary"></v-progress-circular>
        <div style="text-align: center">保存中</div>
      </div>

      <!--✅输入文档名输入框-->
      <v-card v-else>
        <v-form>
          <!-- 标题 -->
          <v-card-title class="px-8">
            <span class="text-h5">请输入保存文档名</span>
          </v-card-title>

          <!-- 输入框 -->
          <v-card-text>
            <v-container>
              <v-text-field color="success" v-model="mdName" class="jh-v-input" dense filled single-line :rules="requireRules"></v-text-field>
            </v-container>
          </v-card-text>

          <!-- 操作 -->
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="" text @click="cancelMdEdit">
              取消
            </v-btn>
            <v-btn color="success" text @click="saveMarkdownContent">
              保存
            </v-btn>
          </v-card-actions>
        </v-form>
      </v-card>
    </v-dialog>
    <!-- <<<<<<<<<<<<< 文档命名弹窗 -->
  </div>
</template>

<!-- 加载页面静态资源 >>>>>>>>>>>>> -->
<link rel="stylesheet" href="/<$ ctx.app.config.appId $>/public/plugin/editor.md/css/editormd.min.css"/>
<script src="/<$ ctx.app.config.appId $>/public/lib/jquery/jquery.min.js"></script>
<script src="/<$ ctx.app.config.appId $>/public/plugin/editor.md/editormd.js"></script>
<!-- <<<<<<<<<<<<< 加载页面静态资源 -->

<script>
Vue.component("markdown-editor", {
  vuetify: new Vuetify(),
  name: 'markdown-editor',
  template: '#markdown-editor',
  props: {
    currentPath: String,
    currentMarkdownItem: {
      type: Object,
      default: {}
    },
  },
  data: () => ({
    requireRules: [v => !!v || '请输入文件名'],
    upload: window.appInfo.upload,
    editor: null,
    markdownContent: null,
    mdName: null,
    isNameDialogShow: false,
    saveIng: false,
    currentMarkdownContent: null,
    isMarkdownEditDialogShow: false
  }),
  watch: {
    async currentMarkdownItem(value) {
      this.currentMarkdownContent = null;
      if(value) {
        this.mdName = value.name;
        this.currentMarkdownContent = value.content;
        this.openMarkdownEditDialog();
      }
    }
  },
  async mounted() {
  },
  methods: {
    /**
     * 检查文档内容是否修改，并提示是否保存
     * @returns {Promise<void>}
     */
    async checkEditStatusAndClose() {
      // 文档内容变动，提示是否要保存
      if (!_.isEmpty(this.markdownContent) && (!this.currentMarkdownContent || (this.currentMarkdownContent && this.markdownContent !== this.currentMarkdownContent))) {
        if (await window.confirmDialog({title: "有内容尚未保存是否保存"})) {
          this.saveMarkdownContent();
          return;
        }
      }
      this.cancelMdEdit();
    },
    /**
     * 取消文档编辑
     */
    cancelMdEdit() {
      this.isMarkdownEditDialogShow = false;
      this.isNameDialogShow = false;
      this.saveIng = false;
      this.mdName = null;
      this.markdownContent = null;
    },
    openMarkdownEditDialog() {
      this.isMarkdownEditDialogShow = true;
      this.initEditorMd();
    },
    /**
     * 保存文档
     */
    saveMarkdownContent() {
      if (!_.isEmpty(this.mdName)) {
        this.isNameDialogShow = true;
        this.saveIng = true;
        const mdName = this.mdName.replace('.md', '');
        if(!this.markdownContent && this.currentMarkdownContent) {
          this.markdownContent = this.currentMarkdownContent;
        }
        this.doSaveMarkdown({content: this.markdownContent, mdName});
      } else {
        this.isNameDialogShow = true;
      }
    },
    async doSaveMarkdown({content, mdName}) {
      if(!content) {
        window.vtoast.fail({message: "文档内容不能为空"});
        return;
      }
      await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'cloud_drive',
            actionId: 'saveMarkdown',
            actionData: {
              content,
              name: mdName,
              path: this.currentPath
            },
          }
        }
      });
      window.vtoast.success("文档保存成功");
      this.$emit("refresh-directory");
      this.isNameDialogShow = false;
      this.saveIng = false;
      this.isMarkdownEditDialogShow = false;
    },
    /**
     * 初始化编辑器
     */
    initEditorMd() {
      console.log(this.currentMarkdownContent)
      const that = this;
      this.$nextTick(() => {
        if (document.getElementById('editorMdContainer')) {
          console.log("that.currentMarkdownContent", that.currentMarkdownContent)
          document.getElementById('editorMdContainer').innerHTML = `<textarea style=\"display:none;\">${that.currentMarkdownContent || ""}</textarea>`;
          that.editor = editormd('editorMdContainer', {
            width: "100%",
            height: "100%",
            watch: false,
            saveHTMLToTextarea: true,    // 保存 HTML 到 Textarea
            htmlDecode: "style,script,iframe|on*",
            path: '/<$ ctx.app.config.appId $>/public/plugin/editor.md/lib/',
            toolbarIcons: Object.freeze([
              "undo", "redo", "|",
              "watch",
              "preview", "|",
              "h1", "h2", "h3", "h4", "h5", "bold", "del", "italic", "quote", "mark",
              "list-ul", "list-ol", "hr", "link", "|",
            ]),
            toolbarIconsClass: {
              audioUpload: 'fa-file-audio-o',
              videoUpload: 'fa-youtube-play',
              imageUpload: 'fa-image',
            },
            onchange: function () {
              that.markdownContent = this.getMarkdown();
            },
          });
        } else {
          requestAnimationFrame(() => {
            this.initEditorMd();
          })
        }
      })
    }
  }
})
</script>

<style scoped>
body {
  overflow: auto;
}

.v-card {
  height: unset;
}

:root {
  --border-color: #eff2f5;
}

.v-dialog--fullscreen .v-sheet {
  height: auto;
  position: relative;
  background: #fff;
  display: block;
}

.editormd, .CodeMirror-gutters, .editormd-toolbar, .editormd .CodeMirror, .editormd-menu > li.divider, .editormd-menu > li > a:hover, .editormd-menu > li > a.active {
  border-color: var(--border-color) !important;
}

.CodeMirror-gutter {
  background-color: #fff;
}

.CodeMirror-scroll {
  overflow-x: hidden !important;
}

.editormd-dialog-close {
  color: #3F4254 !important;
}

.editormd-preview-container ol.linenums li, .editormd-html-preview ol.linenums li {
  list-style-type: none;
}

.editormd-preview-container ol.linenums, .editormd-html-preview ol.linenums {
  color: #999;
  padding-left: 0;
}
</style>
